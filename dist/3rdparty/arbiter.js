var Arbiter=function(){var create_arbiter=function(){var subscriptions={},wildcard_subscriptions={},persistent_messages={},id_lookup={},new_id=1;return{version:"1.0",updated_on:"2011-12-19",create:function(){return create_arbiter()},subscribe:function(){var msg,messages,subscription_list,persisted_subscription_list,subscription,func,context,id,options={},wildcard=!1,priority=0,return_ids=[];if(arguments.length<2)return null;messages=arguments[0],func=arguments[arguments.length-1],arguments.length>2&&(options=arguments[1]||{}),arguments.length>3&&(context=arguments[2]),options.priority&&(priority=options.priority),"string"==typeof messages&&(messages=messages.split(/[,\s]+/));for(var i=0;i<messages.length;i++)if(msg=messages[i],/\*$/.test(msg)?(wildcard=!0,msg=msg.replace(/\*$/,""),subscription_list=wildcard_subscriptions[msg],subscription_list||(wildcard_subscriptions[msg]=subscription_list=[])):(subscription_list=subscriptions[msg],subscription_list||(subscriptions[msg]=subscription_list=[])),id=new_id++,subscription={id:id,f:func,p:priority,self:context,options:options},id_lookup[id]=subscription,subscription_list.push(subscription),subscription_list=subscription_list.sort(function(a,b){return a.p>b.p?-1:a.p==b.p?0:1}),wildcard?wildcard_subscriptions[msg]=subscription_list:subscriptions[msg]=subscription_list,return_ids.push(id),!options.persist&&persistent_messages[msg]){persisted_subscription_list=persistent_messages[msg];for(var j=0;j<persisted_subscription_list.length;j++)subscription.f.call(subscription.self,persisted_subscription_list[j],{persist:!0})}return messages.length>0?return_ids:return_ids[0]},publish:function(msg,data,options){var result,subscriber,wildcard_msg,async_timeout=10,overall_result=!0,cancelable=!0,internal_data={},subscription_list=subscriptions[msg]||[];options=options||{};for(wildcard_msg in wildcard_subscriptions)0==msg.indexOf(wildcard_msg)&&(subscription_list=subscription_list.concat(wildcard_subscriptions[wildcard_msg]));if(options.persist===!0&&(persistent_messages[msg]||(persistent_messages[msg]=[]),persistent_messages[msg].push(data)),0==subscription_list.length)return overall_result;"boolean"==typeof options.cancelable&&(cancelable=options.cancelable);for(var i=0;i<subscription_list.length;i++)if(subscriber=subscription_list[i],!subscriber.unsubscribed)try{if(options.async===!0||subscriber.options&&subscriber.options.async)setTimeout(function(inner_subscriber){return function(){inner_subscriber.f.call(inner_subscriber.self,data,msg,internal_data)}}(subscriber),async_timeout++);else if(result=subscriber.f.call(subscriber.self,data,msg,internal_data),cancelable&&result===!1)break}catch(e){overall_result=!1}return overall_result},unsubscribe:function(id){return id_lookup[id]?(id_lookup[id].unsubscribed=!0,!0):!1},resubscribe:function(id){return id_lookup[id]?(id_lookup[id].unsubscribed=!1,!0):!1}}};return create_arbiter()}();